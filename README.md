# GSpan.js

A script that downloads an [anno-docs](https://github.com/nprapps/anno-docs)-formatted Google Doc and translates it into JSON â€“ using JavaScript. It also uses native Google Comments for annotations instead of the syntax created from `anno-docs` annotations. It comes in two flavors: a CLI and a Node.js API which can be used directly in Node.js runtime.

## Installation

Using your method of choice:

```
$ npm install gspan
```

```
$ yarn add gspan
```

```
$ npm install -g gspan
```

## Setup

In order to use this app you'll need a Google Service Account which has viewing access to your Google Doc. For help with creating a Google Service Account, see [Making A Google Service Account](docs/GoogleServiceAccount.md).

Once you have your credentials file, you'll need the `client_email` and `private_key`. You'll need to make sure that these are saved as environment variables in your runtime under the keys of `GAPI_CLIENT_EMAIL` and `GAPI_PRIVATE_KEY` respectively.

There's a number of ways to do this depending on your workflow. If you've never worked with environment variables in node check out [this guide](https://www.twilio.com/blog/2017/08/working-with-environment-variables-in-node-js.html).

## Quick Usage

##### Transcribing from C-Span into a Google Doc

```
gspan transcribe <doc>

Begins transcribing CSPAN into a document.

Positionals:
  doc  The Google Doc ID                                     [string] [required]

Options:
  --verbose, -v     Log new entries in the console                     [boolean]
  --backfill, -b    Start from a saved backup file                     [boolean]
  --backupFile, -f  A filepath to save a backup                         [string]
  --limit, -l       A limit of iterations.                              [number]
```

#### Downloading and parsing data from a Google Doc

```
gspan download <doc> [output]

Downloads a GSpan doc as a JSON file.

Positionals:
  doc     The Google Doc ID                                  [string] [required]
  output  The directory to save the file to                             [string]

Options:
  --authorAPI, -a           A link to an authors API                    [string]
  --authorNameAccessor, -n  Accessor for Google display name            [string]
  --authorIdAccessor, -i    Accessor for unique ID                      [string]
  --defaultPublish, -p      Default for annoation published state      [boolean]
```

<em>* Boolean arguments can be set to false by setting them equal to false or by adding the `no-` prefix to their name. (e.g. `gspan transcribe DOC_ID --no-verbose` or `gspan download DOC_ID -p=false`)

## The Data

Gspan's `download` function is designed to be able to parse a document created by its own `transcribe` function. For help annotating a Google Doc see [Annotating Docs](docs/AnnotatingDocs.md). Given a transcribed and annotated Google Doc that looks like this:

![doc](docs/images/doc.jpg)

The parsed data will look like this:

```javascript
{
  //  all authors with annotations will go here
  "users": {
    "Andrew Briz": {
      "kind": "drive#user",
      "displayName": "Andrew Briz",
      "photoLink": "//lh3.googleusercontent.com/a-/AAuE7mBO9mjHMIvQ0Ja4mXCbm1r3R5Sl66FyCT-arfkWCg=s96-k-no",
      "me": false
    }
  },
   // content is an array with different types of content blocks
  "content": [
    {
      // content type 1/3: "attribution" represents changes in speakers
      "type": "attribution",
      // value will be the name of the attribution
      "value": "SPEAKER 1",
      "annotations": [],
      // content block IDs are generated via their value and (in the case of duplication) their index in the content array
      "id": "27de876452788f6b6e2818bcbe31cd9a"
    },
    {
      // content type 2/3: "content" represents regular blocks of text
      "type": "content",
      // value will be the text of the paragraph
      "value": "Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.",
      // annotations is an array of comments in order of the content they're highlighting
      "annotations": [
        {
          // annotation IDs are generated by the Google Comments API
          "id": "AAAAChQtmA0",
          // The author here will always match with a key in users
          "author": "Andrew Briz",
          // The final text of the comment (after any edits)
          "text": "A comment.",
          // Extra keys can be provided to provide data about the comment
          "tags": {
            "key": "value"
          },
          // Whether this comment should be published
          "published": true,
          // The location of the comment (see below)
          "location": [
            101,
            116
          ]
        }
      ],
      "id": "fa5c89f3c88b81bfd5e821b0316569af"
    },
    {
      // content type 3/3: "soundbite" represents a soundbite seen in the caption
      "type": "soundbite",
      // value will be the text of the soundbite
      "value": "(applause)",
      "annotations": [],
      "id": "12afe57843d6ed0f35e165b16d854860"
    },
    {
      "type": "attribution",
      "value": "SPEAKER 2",
      "annotations": [],
      "id": "9109a65f5f3d2f897aed98e591082619"
    },
    {
      "type": "content",
      "value": "Duis ac elit ut massa vehicula condimentum. Proin posuere massa sed dapibus varius. Suspendisse aliquet aliquam lectus. Cras quis leo neque. Vestibulum tristique consectetur enim, vel semper ligula ullamcorper auctor. Praesent rutrum metus quis efficitur posuere. Sed eros massa, tempus a luctus eu, feugiat vel nisl.",
      "annotations": [
        {
          "id": "AAAAChQuchI",
          "author": "Andrew Briz",
          "text": "An edited draft comment.",
          "tags": {
            "key": "value",
            "key2": "value2"
          },
          // publish is set to false because of the "unpublish" reply
          "published": false,
          "location": [
            120,
            140
          ],
          // if a comment was edited, the original comment text will be preserved in "original". The user will remain the information for the original creator of the annotation
          "original": "A draft comment."
        }
      ],
      "id": "b439c27194e132903f7006b7d4e07b36"
    },

    // note that if a speaker doesn't change, no attribution block is exported
    // even if one exists in the Google Doc

    {
      "type": "content",
      "value": "Quisque ex turpis, sollicitudin et venenatis eu, porttitor sit amet leo. Sed dapibus, sem a venenatis luctus, sem urna eleifend enim, non dignissim ante ante quis mi. Mauris sodales sem ut erat rhoncus, nec dignissim eros mollis. Mauris venenatis finibus lectus, id dignissim lectus volutpat nec.",
      "annotations": [],
      "id": "f238d2990c2804fdeb4b16351e1cb111"
    }
  ]
}
```

### Users
`users` is an object with unique IDs of all the active users referenced in the annotations.

### Content
`content` is an array of content objects with an `id`, `type`,`value`, and `annotations` which are comments made about the content object.

#### Type & Value
Each content type has the same four properties. The only difference is what their `value` represents:

| Type | Value
| --- | --- |
| `attribution` | The name of the speaker |
| `soundbite` | The text of the soundbite |
| `content` | The text of the paragraph |

#### Annotations
Annotations is an array of comments made about that content in the Google Doc. They have a `text` key which is the value of the comment. These will be parsed using a custom text parser (see [Formatting Comments](docs/FormattingComments.md)).

###### Publish
These annotations have `publish` set to the `publishDefault` (see [Downloading A Parsed Doc](docs/DownloadingADoc.md)). They can be set to `true` by replying `publish` or to `false` by replying `unpublish`. The last `publish` / `unpublish` replied will be respected.

###### Tags
Annotators can also reply with a `key: value` syntax to create a set of `tags` for that annotation.

###### Author
`author` is an ID that will match a property in the `users` object.

###### Location
Finally, the location of the highlighted text is available in the `location` array. The first value of this array is the position where the highlight starts. The second value is the position (up to, but not including) where the highlight ends. This format is used so that (given the example photo above) this code works:

```javascript
const block = {
  "type": "content",
  "value": "Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.",
  "annotations": [
    {
      "id": "AAAAChQtmA0",
      "author": "Andrew Briz",
      "text": "A comment.",
      "tags": {
        "key": "value"
      },
      "published": true,
      "location": [
        101,
        116
      ]
    }
  ],
  "id": "fa5c89f3c88b81bfd5e821b0316569af"
};

const loc = block.annotations[0].location;
const highlighted = block.value.substring(loc[0], loc[1]);


// if using the ES6 spread operator...
const highlightedSpread = block.value.substring(...loc);

console.log(highlighted);
// expected: "et dolore magna"

console.log(highlighted === highlightedSpread)
// expected: true
```
